

## 前言
数据库三个优化方向：

- 查询优化
- 索引优化
- 库表结构优化

这三个缺一不可，需要齐头并进。

本章说明如何真正的执行查询，以及高效和低效的原因所在。扬长避短。



## 为什么查询速度会慢



#### 查询的生命周期

客户端=》

服务器=》解析=》生成执行计划=》

执行=》

返回结果给客户端。



其中执行是整个生命周期中最重要的部分，涉及到数据的检索，以及检索后的数据处理，如排序、分组等。



#### 主要原因

查询慢的主要原因是可能是执行了一些不必要的额外操作，或是某些操作被重复的执行很多次，又或是某些操作执行的太慢。



## 慢查询基础：优化数据访问

性能低下的最基本原因是访问的数据太多，这包括两方面：

1. 检索大量超过需要的数据。也就是访问了太多行或者访问了太多列，有时候有些数据不是需要的，但都向数据库申请查询了。
2. MySQL服务器层分析了大量超过需要的数据行。在没有冗余需求的情况下，数据库引擎返回了大量不必要的数据供服务器层分析。

### 请求了不需要的数据

- 查询不需要的记录：一个误区：MySQL只会返回需要的数据。实际上是MySQL先返回全部结果集然后再进行计算
- 多表关联时返回全部列：只需取出需要的列即可
- 总是取出全部列：就是总是使用select * 。
- 重复查询相同的数据：可以在初次查询该数据时将其缓存起来以便下次使用，而不是再次去数据库查询。



### MySQL是否在扫描额外的记录

在确定查询只返回需要的数据后，要看看查询为了返回结果是否扫描了过多的数据。衡量指标是：响应时间、扫描的行数以及返回的行数。



## 查询执行的基础

![1563765028610](C:\Users\PantaSun\AppData\Roaming\Typora\typora-user-images\1563765028610.png)

1. 客户端发送一条查询给服务器
2. 服务器先检查查询缓存，若命中缓存，则立即返回存储在缓存中的结果。否则进入下一步
3. 服务器进行SQL解析、预处理，再由优化器生成对应的执行计划
4. MySQL根据优化器生成的执行计划，调用存储引擎的api来执行查询
5. 将结果返回给客户端

### MySQL客户端/服务端通信协议

MySQL客户端和服务端之间的通信协议是半双工的，在同一时刻要么由客户端发送，要么由服务端发送数据。

多数连接MySQL的库函数都可以获取全部结果集并缓存在内存中。当从MySQL获取数据时，其结果看似像是从MySQL服务器直接获取数据，实际上都是从整个数据库的缓存获取数据。



#### 查询状态

- sleep：线程正在等待客户端发送新的请求
- query：线程正在执行查询或者正在将结果发送给客户端
- locked：在MySQL服务层，该线程正在等待表锁。在存储引擎级别的锁，如innodb的行锁，并不会出现在线程状态中
- analysiing and statistics：线程正在收集存储引擎的统计信息，并生成查询的执行计划
- copying and tmp table [on disk]：线程正在执行查询并将其结果集都复制在一个临时表中，这种状态一般要么是做group by要么是文件排序操作，或者是union操作。
- sorting result：线程正在对结果集进行排序
- sending data：这表示多种情况：线程可能在多个状态之间传送数据，或者在生成结果集，或者向客户端返回数据。

### 查询缓存

1. 先看缓存是否打开
2. 若打开再使用一个对大小写敏感的哈希查找对本次查询与缓存中的查询相匹配，若有一个字节不同就不算匹配
3. 若匹配成功，则查看用户权限，若权限无问题就返回结果

### 查询优化处理

这一步主要是将一个sql语句转化为一个执行计划，包括几个子阶段：解析sql，预处理，优化sql执行计划。在此期间若出现任何问题都会导致终止查询。

#### 解析器与预处理器

通过关键字讲sql语句解析并生成一棵解析树

预处理器根据一些MySQL规则进一步检查解析树是否合法，如验证表和列是否存在等

预处理器还会验证权限

#### 优化处理器

将语法树转化为执行计划。一个查询可能有多种执行方式，最后都返回相同的结果。优化器的作用就是找到这些执行方式中最好的执行计划。

![1563779888634](C:\Users\PantaSun\AppData\Roaming\Typora\typora-user-images\1563779888634.png)