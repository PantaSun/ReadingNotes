## 端口号

端口号使用来识别同一计算机上进行通信的不同应用程序，也成程序地址。



**识别一个通信**

在TCP/IP或UDP/IP通信中一般使用五个信息来识别一个通信

- 源IP地址
- 目标IP地址
- 协议号
- 源端口号
- 目标端口号



## TCP

TCP通过检验和、序列号、确认应答、重发机制、连接管理以及窗口控制等机制实现可靠传输。



**确认应答：** 接收端收到数据后会给发送端返回一个已收到消息的通知，这个消息就是确认应答。

**序列号：**是按顺序给发送数据的每一个字节都标注上的编号。

接收端查询收到数据TCP首部中的序列号和数据长度，将自己下一步应该接收的序列号作为确认应答发送回去。

**重发超时：**指在重发数据之前，等待确认应答到来的那个特定时间间隔。如果超过这个时间间隔没有收到确认应答就进行重发。



### 连接管理

可以使用TCP首部用于控制的字段来管理连接。一个连接的建立与断开，至少需要7个包才能完成。

**三次握手**：建立一个TCP连接需要发送3个包，这个过程也被称作“3次握手”。

**TCP以段为单位发送数据：**这个数据段的大小被称为最大消息长度（MSS：Maximum Segment Size），是在三次握手过程中确定的。MSS是IP中不会被分片处理的最大数据长度。

**MSS：**两段主机在建立连接请求时，会在TCP首部中写入MSS选项，告知对方自己的接口能够适应的MSS，然后会在两者中选择较小的的值投入使用。

### 利用窗口发送数据

上述方法在每次发送数据后都要等待接收方发回确认应答以便于继续发送，但是包的往返时间越长通信新能就越低。

引入窗口的概念，确认应答不是以每个段，而是以更大的单位进行确认，这时候发送的间隔会降低，发送时间也会大幅度缩短。

窗口的大小就是指无需等待确认应答而可以继续发送数据的最大段数。要实现这个机制就要用到缓冲区，因为在一个窗口内的某个段可能会发送失败或无法到达，这就需要重新发送，这就需要事先将本窗口数据缓存起来。当收到窗口内段的确认应答后再从缓冲区清楚该段数据。

收到一个段的应答后，窗口就向后滑动一次。

**关于在窗口机制下的重发**

因为窗口机制下一下是发送多个段给接收端，而接收端可能没有接收到某一段数据，接收端就会不停的向发送端发送丢失数据段的上一段的确认应答（因为这个确认应答中的序列号就是丢失数据段的起始序列号），发送端连续3次收到这个确认应答后就会重新发送这段丢失的数据段。



### 流控制

就是让发送端根据接收端的实际接收能力控制发送的数据量。这个限制就是之前说的窗口的大小，在TCP首部中专门有一个字段来存放窗口大小。

因为窗口大小会实时变化，而窗口更新通知也可能在途中丢失，所以发送端也会时不时的发送一个仅含一个字节的窗口探测包来获取窗口大小。



### 提高网络利用率的规范

#### Nagle算法

发送端还有一部分数据需要发送，但这部分数据比较小时，就延迟发送。具体就是当满足下列两个条件之一时才能发送数据：

- 已发送的数据都接收到了确认应答
- 可以发送最大段长度（MSS）的数据时。