为什么要有锁：

在开发多用户数据库应用时，既要最大程度的利用数据库的并发访问，还要确保每个用户能以一致的方式读取和修改数据是相互冲突的。因此使用锁机制来解决上述问题。

## 什么是锁

锁机制用于管理对共享资源的并发访问。

## innodb存储引擎中的锁

在innodb中实现了两种标准的行级锁：

- 共享锁（S Lock）：允许事务读一行数据
- 排它锁（X Lock）：允许事务删除或更新一行数据

s锁兼容其他s锁，而x锁与其他x或s都不兼容

所谓兼容就是，当事务t1  已经获得了行r的共享锁，那么另外的事务t2可以立即获得r行的共享锁，因为读操作并没有改变行r的数据，这种情况为锁兼容。但事务t3想获得行r的排他锁，则其必须等待t1和t2释放行r上的共享锁。这种情况就是锁不兼容。

#### 意向锁

innodb支持多粒度锁定，允许事务在行级上的锁和表级上的锁同时存在。于是InnoDB支持一种额外的锁方式，称为意向锁（intention lock）。 

意向锁意味着希望在更细粒度上进行加锁。

InnoDB中意向锁设计的比较简单，可以理解为是表级别的锁。其设计目的就是为了在一个事务中揭示下一行将被请求的锁类型。

两种意向锁：

- 意向共享锁（IS LOCK），事务想要获取一张表中某几行的共享锁
- 意向排他锁（IX LOCK），事务想要获取一张表中某几行的排他锁

![1566008579055](C:\Users\PantaSun\AppData\Roaming\Typora\typora-user-images\1566008579055.png)

#### 一致性非锁定读

俗称快照读，是指InnoDB引擎通过多版本并发控制的方式来读取当前执行时间数据库中行的数据。如果读取的行正在执行update或delete操作（会锁定行），这时候读操作不会因此去等待行上的锁释放。相反，InnoDB会去读行的一个快照数据。![1566009245962](C:\Users\PantaSun\AppData\Roaming\Typora\typora-user-images\1566009245962.png)

因为这里没有等待访问的行上的x锁释放，所以叫一致性的非锁定读。

快照数据指的是该行之前版本的数据，该实现是通过undo段来完成的。

快照读是InnoDB默认的读取方式，即读取不会占用和等待表上的锁。在不同事务隔离级别下，默认读的方式不同，即使都是一致性非锁定读，其快照数据的定义也不同：

- 在read commitied级别中，快照读总是读取被锁定行的最新一份快照数据。                                                                              
- 在repeatable read级别中，快照读是读取事务开始时的行数据版本。

rr级别的演示：![1566011121900](C:\Users\PantaSun\AppData\Roaming\Typora\typora-user-images\1566011121900.png)

#### 一致性锁定读

有时候用户显示对数据库读取操作进行锁定以保证数据逻辑的一致性。这就需要一致性锁定读。

InnoDB支持的两种一致性锁定读：

- select... for update; 就是行级排它锁
- select...lock in share mode；就是行级共享锁

