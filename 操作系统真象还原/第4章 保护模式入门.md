实模式的一些特点（缺点）：

1. 实模式下操作系统和用户程序属于同一特权级
2. 用户所引用的地址都是指向真实的物理地址，即逻辑地址等于物理地址
3. 用户程序可以自由修改段基址

上述三条存在严重的安全隐患，一旦用户恶意操作内存，将产生不可预计的后果。

4. 访问超过64KB的内存区域时要切换段基址
5. 一次只能运行一个程序，无法充分利用计算机资源
6. 共20条地址线，最大可用内存为1MB，这不符合现在海量数据的环境。



为了克服这些缺点，处理器厂商开发出保护模式。因此物理内存地址不能直接被程序直接访问，程序内部的地址（虚拟地址）需要被转化为物理地址后再去访问。

地址转换是由处理器和操作系统共性协作完成的，处理器在硬件上提供地址转换部件，操作系统提供转换过程中所需要的页表。

**实模式：**是32位CPU中的概念，指32位的CPU处于16位运行模式下的状态。



### 寄存器的扩展

因为在32位CPU中地址总线和数据总线也扩展到32位，其寻址空间达到了2的32次方，即4GB。为了让一个寄存器能够访问到4GB空间，需要将寄存器宽度提升至32位。

**除了段寄存器外，其他寄存器都由16位扩展到32位。**在原来的寄存器前加个e表示扩展。

寄存器中低16位是为了兼容实模式，可以单独使用。高16位没办法单独使用，只有在用32位寄存器时才有机会用到他们。



在保护模式中偏移地址和实模式中的一样，但是段基址就不一样了。保护模式中使用段描述符来存放内存段的描述信息，这些描述符存放在一个全局描述符表中GDT。这时段寄存器中放的只是一个选择子，用来索引GDT中的段描述符。

GDT因为比较大所以存放在内存中，由GDTR寄存器指向该表首地址。

### 寻址扩展

在实模式下，内存寻址只能使用几个固定的寄存器来操作，如基址寄存器bx、bp和变址寄存器si、di。

到了保护模式下，内存寻址的基址寄存器可以是所有32位的通用寄存器，变址寄存器可以是除了esp之外的所有32位通用寄存器。

### 运行模式反转

为了兼容16位运行模式，32位指令格式也与16位相同。在这种情况下位了区分不同运行模式，32位运行模式重新定义各寻址方式、寄存器的编码。

但是编译器不知道你是想将一句代码编译成16位模式的还是32位模式的，因此可以使用一个位指令bits来通知编译器：

- [bits 16]告诉编译器，下面的代码编译成16位的机器码
- [bits 32]告诉编译器，下面的代码编译成32位的机器码
- 所谓“下面”是指从当前bits到下一个bits之间的代码
- 中括号可以省略



#### 反转前缀

- 操作数反转前缀0x66：如果要用另一种模式下的操作数大小，需要在指令前添加指令前缀0x66，将当前模式临时改变成另一种模式，这就是反转的意思。不管当前模式是什么，总能反转成相反的运行模式（相反值得是16位和32位相反）

- 寻址方式反转前缀0x67，比如在16位模式下使用了eax寄存器，当编译成机器码时就会有一个0x67前缀。

### 指令扩展

**关于push命令：**

- push 8位立即数：由于CPU要考虑对其，所以操作数要么是16位要么是32位，所以8位立即数会被扩展为各模式下默认操作数宽度，即实模式下8位立即数扩展为16位，保护模式下扩展为32位。
- push 16位立即数，CPU直接将其入栈，sp-2
- push 32位立即数，CPU直接将其入栈，sp-4

**段寄存器的入栈，无论在哪种模式下，都按当前模式的默认操作数大小入栈。**

**对于通用寄存器和内存入栈，无论实模式还是保护模式：**

- 如果压入的是16位数据，栈指针减2
- 如果压入的是32位数据，栈指针减4



## 全局描述符表GDT（Global Descriptor Table）

- 段描述符占8个字节，其中段基址占4个字节即32位
- 段界限表示段边界的扩展最值，就是表示段的边界、大小、范围。
- 段基址和段界限在段描述符中不是连续存放的，这是为了兼容当时80286CPU的。

#### 详细说明段描述符

- 从低32位开始：0～15位用来存放段界限的0～15位，16～31位用来存放段基址的0～15位
- 高32位中（这里高32位位了说明也从0开始算起，也就是0～31，但实际表示的是32～63）：0～7位是段基址的16～23，24～31是段基址的24～31，算上低32位中的16～31位段基址的全部32位已经齐了。
- 高32位中：8～11位是type字段。共四位，用来指定本描述符的类型。要在S字段确定后才有意义。
  - 当S为1时，即非系统段时，type有两种情况：
    - 代码段：四位从低到高分别为A、C、R、X
    - 数据段：四位从低到高分别为A、E、W、X
- 高32位中：第12位是S字段，用来指示是否是系统段。S为0表示系统段，S为1表示非系统段（数据段，代码段也算在数据段中）。S跟type字段配合使用。
- 高32位中：13～14位时DPL字段 Descriptor Privilege Level，特权描述符，指所代表的内存段的特权级。
- 高32位中：
- 高32位中：