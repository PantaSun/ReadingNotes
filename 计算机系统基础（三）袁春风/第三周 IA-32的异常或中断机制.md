## x86实地址模式下的异常/中断处理

- 有256种不同类型的中断和异常
- 每个中断和异常都有独一无二的编号，即中断类型号
- 每个中断和异常都有与其对应的中断服务程序或异常服务程序
- 0-31号（前32个类型）保留给CPU使用，剩余的由用户自定义（这里的用户指的是机器硬件的用户，也就是操作系统）
- 通过使用INT n使CPU自动转到操作系统给出的中断服务程序执行
- 实模式下，用中断向量表描述
- 保护模式下，用中断描述符表描述

### 实地址模式下的中断向量表

实地址模式寻址空间为1MB，指令地址=CS<<4 + IP。因此中断向量表中就存放着16位CS和16位IP一共32位。一个表项是32位就是4个字节，一共256项，因此中断向量表在内存中占用256\*4B=1KB。只要知道中断或异常的编号，用编号乘以4就能得到表项在中断向量表中的地址。



### 开机流程

- 开机后系统首先在实地址下工作
- 开机过程中，先准备在实模式下的中断向量表和中断服务程序。这一流程由固化在主板上的BIOS程序完成
- BIOS会检查显卡、键盘、内存等并在000000H~003FFH区建立中断向量表，在向量表所指的主存区建立相应的中断服务程序
- BIOS利用INT指令执行特定的中断服务程序把**操作系统（OS）**从磁盘加载到内存中。
- BIOS（BasicInput/Output System）基本输入输出系统，针对具体主板而设计，原装的操作系统无关
- BIOS包含各种基本设备的驱动程序，通过执行BIOS程序，基本设备驱动程序以中断服务程序的形式被加载到内存中，以提供基本IO系统调用。
- 一旦进入保护模式，就不再使用BIOS。



## x86保护模式下的中断/异常处理

### 中断描述符表

- 在保护模式下，通过中断描述符表来获取中断或异常服务程序的入口地址
- 中断描述符表（InterruptDescriptor Table， IDT）是操作系统内核中的一个表，共有256个表项，每个表项占8个字节，IDT共占2KB
- ITDR中存放IDT的首地址
- 每一个表项是一个中断门描述符、陷阱门描述符或任务门描述符
- 中断门描述符格式：
  - 段选择符：用来指示异常处理程序或中断服务程序所在的段的段描述符在GDT中的位置，其RPL=0
  - 偏移地址：给出异常处理程序或中断服务程序第一条指令所在的偏移量
  - DPL：访问本段的最低权级
  - TYPE：表示门的类型。1110B表示中断门；1111B表示陷阱门；0101B表示任务门
  - P：用于表示对应的段（即异常处理程序或中断服务程序所在的段，通常指内核代码段）是否存在，而不是表示对应中断类型是否存在。

### IA-32中异常和中断响应过程

1. 确定中断类型号i；从IDTR指向的IDT中取出第i个表项IDTi。
2. 根据IDTi中段选择符，从GDTR指向的GDT（Global Descriptor Table，全局描述符表）中取出相应段描述符
3. 判断权限，若CPL<DPL或编程异常IDTi的DPL<CPL，则发生13号异常。Linux中前者不会发生，而后者用于防止恶意程序模拟INT n陷入内核进行破坏性操作。
4. 若CPL不等于DPL，则从用户态切换至内核态
5. 若是故障，则将发生故障的指令和逻辑地址写入CS和EIP
6. 在当前栈中保存断点和程序状态
7. 若异常产生了一个硬件出错码，则将其保存在内核中
8. 将IDTi中的段选择怒装入CS，IDTi中的偏移地址装入EIP，他们是异常处理程序或中断服务程序的第一条指令的逻辑地址

