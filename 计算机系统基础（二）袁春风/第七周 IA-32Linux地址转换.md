## IA-32的地址转换

### IA-32的存储管理

- 按字节编址
- 在保护模式下，IA-32采用段页虚拟存储管理方式
- 存储地址采用逻辑地址、线性地址和物理地址（逻辑地址到线性地址的转换由分段完成，线性地址到物理地址的转换由分页完成）：逻辑地址和线性地址是虚拟地址的两种不同表示形式，描述的都是4GB虚拟地址空间中的一个存储地址。
- 逻辑地址有48位：16位段选择符和32位段内偏移量
- 线性地址32位
- 物理地址32位



### IA-32处理器逻辑地址到线性地址转换

#### IA-32处理器的寻址方式

举例：

`movw 8(%ebp, %edx, 4), %ax  // R[ax] <= M[R[ebp] + R[edx] * 4 +8]`

- 这里`8`是偏移量 `A`
- `%ebp`是基址寄存器 `B`
- `%edx`是变址寄存器 `I`
- `4` 是比例因子 `S`
- 还有一个隐含的段寄存器（`SR`）
- 有效地址 `EA = （B）+（I）*S + A`，有效地址其实就是段内的偏移量

所以线性地址 `LA = （SR）+ EA`  即  `LA = （SR）+（B）+（I）*S + A`

LA的由来：根据SR段寄存器中的 段选择符Index去段表中找到相应的段表项（描述段的信息，如段长，段的起始地址等），从中获取段基址，再加上有效地址最后得到线性地址。

段表在主存中。

之后再由线性地址分页，根据页表得到物理地址。



## 段选择符和段寄存器

### 段寄存器

- 栈段寄存器：SS
- 辅助段寄存器：ES、GS、FS
- 数据段寄存器：DS
- 代码段寄存器：CS

段寄存器用来存放16位段选择符

### 段选择符

段选择符分为3个字段：

- 最后一个字段是2位表示管理状态（请求特权级）RPL，当RPL=00，为第0级，位于最高级的内核态；RPL=11为第3级，位于最低级的用户态。也就是说第0级高于第3级。
- 对于CS段寄存器来说最后两位表示当前特权级（Current privilege Level, CPL）
- 第二个字段是1位，TI，当TI=0，选择全局描述符表（GDT），当TI=1，选择局部描述符表（LDT）
- 第一个字段是高13位，用来确定当前使用的段描述符在描述符表中的位置。

### 段描述符和段描述符表

段描述符是一种数据结构，实际上就是段表项，分为两类：

- 普通的代码段和数据段描述符（包括用户和内核的代码和数据）
- 系统控制段描述符，有分为两种：
  - 特殊系统控制段描述符，包括：局部描述符表（LDT）描述符和任务状态段（TSS）描述符
  - 控制转移类描述符，包括：调用门描述符、任务门描述符、中断门描述符和陷阱门描述符

描述符表实际上就是段表，由描述符表组成，分三种：

- 全局描述符表GDT：只有一个，用来存放系统内每个任务共用的描述符
- 局部描述符表LDT：存放某任务专用的描述符
- 中断描述符表IDT：包含256个中断门、陷阱门和任务门描述符



### 逻辑地址向线性地址转换

逻辑地址就是16位的段选择符从段描述符表中找到对应段描述符。段选择符中的TI为0就去GDT中寻找段描述符，如果TI为1就去LDT中寻找段描述符。



