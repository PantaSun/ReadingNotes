研发网络应用程序的核心是写出能在不同的端系统和通过网络彼此通信的程序。

套接字是同一台主机应用层与运输层之间的接口。

拥塞控制：当发送方和接收方之间的网络出现拥塞时，TCP的拥塞控制机制会抑制发送进程。

应用层协议：定义了运行在不同端系统上的应用程序进程如何相互传递报文。特别是应用层协议定义了：

- 交换的报文类型
- 各种报文类型的语法
- 字段的语义
- 一个进程何时以及如何发送报文，对报文进行响应的规则。



## Web和HTTP

Web的应用层协议是HTTP（HyperText Transfer Protocol，超文本传输协议）

在Web中，每个页面是由对象组成的。对象可以是hhtml文件、JPEG图像、一个java小程序或一个视频片段。

每个对象可以通过一个url地址寻址。

url地址有两部分组成：

- 存放对象的服务器主机名
- 对象的路径名

HTTP使用TCP作为它的支撑运输协议。

HTTP服务器不存储任何关于客户的状态信息。HTTP是一个无状态协议。

#### 往返时间（Round-Trip Time， RTT）：指一个短分组从客户到服务器然后再返回客户所花费的时间

具体包括：分组传播时延、分组在中间路由器和交换机上的排队时延以及分组处理时延。



#### 非持续连接：每个请求/响应对是经一个单独的TCP连接发送

缺点：

- 必须为每一个请求的对象建立和维护一个全新的连接，这给web服务器带来严重的负担。
- 每一个对象经受两倍RTT的交付实验，即一个RTT用于创建TCP，另一个RTT用于请求和接收一个对象。

####持续连接：所有请求及响应经相同的TCP连接发送

在默认情况下，HTTP使用持续连接。



### HTTP报文格式

#### 1. HTTP请求报文

- 请求行格式为：方法字段 空格 URL字段 空格 HTTP版本字段。 例如：GET /somedir/page.html HTTP/1.1
  - 方法字段有几种不同的值：GET、POST、HEAD、PUT和DELETE
  - HEAD：类似于GET。当服务器收到使用HEAD方法的请求时，会用一个报文进行响应，但并不返回请求对象。
  - PUT：与web发型工具联合使用允许用户上传对象到指定的web服务器上的指定路径
  - DELETE：允许用户或者应用程序删除web服务器上的对象。
- 首部行：
  - Host:  www.someschool.edu 。指明对象所在的主机。首部行提供的信息是Web代理告诉缓冲所要求的。
  - Connection: close。该浏览器告诉服务器不希望使用持续连接，它要求服务器在完成发送请求的对象后就关闭这条连接。
  - User-agent: Mozilla/5.0。用来指明用户代理，即向服务器发送请求的浏览器的类型。
  - Accept-language: fr。表示用户想得到该对象的法语版本。如果服务器中没有法语版本就会发送默认版本。
- 最后一行再附加一个回车换行符。

在请求报文的通用格式中最下面还有一个实体主体，当使用GET方法时，实体为空；在使用POST方法时（一般用来提交表单）才使用该实体。（用表单生成的请求报文不是必须使用POST方法）



#### 2. HTTP响应报文

- 初始**状态行**，格式：协议版本 空格 状态码 空格 相应的状态信息
  - 常见状态码与状态信息：
    - 200 OK：请求成功，信息在返回的响应报文中
    - 301 Moved Permanently：请求的对象被永久转移了，新的URL在响应报文的Location首部行中。客户软件将自动获取新的URL
    - 400 Bad Request：一个通用差错代码，指示该请求不能被服务器理解
    - 404 Not Found：被请求的文档不在服务器上
    - 505 HTTP Version Not Supported：服务器不支持请求报文使用的HTTP协议版本。
- 首部行：
  - Connection：有两种方式，在请求报文中也是如此
    - close：告诉客户，发送完该报文后将关闭该TCP连接
    - keep-alive： 保持连接不关闭
  - Date: Tue, 09 Aug 2011 15:44:04 GMT。指示服务器产生并发送该响应报文的日期和时间。不是指创建或最后修改时间而是服务器从文件系统中检索到该对象，插入响应报文，并发送该响应报文的时间。
  - Server: Apache/2.2.3 (Centos) 或nginx。表示该报文是由一台Apahce web服务器产生的。
  - Last-Modified: Tue, 09 Aug 2011 15:11:03 GMT。表示了对象创建或者最后修改的日期和时间。
  - Content-Length：表示被发送对象的字节数
  - Content-Type: text/html。表示实体中的对象类型，这里表示html文本。
  - 一个空行
- 实体行：是报文的主要部分，包含了所请求的对象本身。

### cookie

#### cookie技术有四个组件：

- 在HTTP响应报文中的一个cookie首部行
- 在HTTP请求报文中的一个cookie首部行
- 在用户端系统中保留有一个cookie文件，并由浏览器进行管理
- 位于web站点的一个后端数据库

#### cookie的具体工作流程：

1. 浏览器像某个服务器发起请求，当请求报文到达服务器后，服务器将为该浏览器产生一个唯一识别码，并以此为索引在它的后段数据库中产生一个表项
2. 服务器在HTTP响应报文中用一个"Set-cookie: 识别码"的首部行通知浏览器
3. 浏览器收到响应报文后，识别到Set-cookie后就在浏览器管理的特定cookie文件中添加一行，该行包括服务器主机名和识别码
4. 当浏览器再次访问该服务器时，请求报文中会有一个“cookie:识别码”首部行，这里的识别码是之前保存下来的。
5. 服务器根据这个识别码可以跟踪用户在本站点的一切活动。若用户注册过，则该用户的注册信息也会保存到数据库中识别码对应的表项中。

**总的来说cookie可以在无状态的HTTP之上建立一个用户会话层。**



### web缓存

web缓存也叫代理服务器，它是能代表初始web服务器来满足http请求的网络实体。

#### web缓存的工作流程：

1. 浏览器建立一个到web缓存起的TCP连接，并向web缓存器中的对象发起一个HTTP请求
2. web缓存器收到请求后检查本地是否有所请求的对象副本。若有，web缓存器直接向浏览器通过http响应报文的方式发送所请求的对象。
3. 若没有，则web缓存器就创建一个与该对象初始服务器的TCP连接。然后web缓存器向初始服务器发送对该对象的http请求。服务器收到请求后向web缓存器发送含有该对象的http响应报文。
4. web缓存器收到初始服务器的响应后，它在本地存储空间存储一份副本，并向浏览器用http响应报文发送该对象副本。

#### 互联网是部署web的两个原因：

1. 大大减少对客户请求的响应时间
2. 能够大大减少一个机构的接入链路到因特网的通信量。这样该机构就不用增加带宽，从而降低费用。

#### 条件GET方法

web缓存器如何更新本地对象副本。

可以使用条件get方法，如果请求报文使用get方法且请求报文中包含一个“If-Modified-Since”首部行，就是一个条件get方法。

**工作流程：**

1. 假设一个对象已经在web缓存器中存在副本，当一个浏览器想要请求该对象时，web缓存器向初始服务器发送一个条件get执行最新检查。
2. If-Modified-Since对应的值是上次初始服务器发来的对象响应报文中的Last-Modified的值，也就是说web缓存器知道上次发来对象时该对象的最新修改时间，但是已经过了一段时间了，web缓存器不知道该对象从上次发来到现在这段时间是否修改过，所以才发这个请求进行检查
3. 若服务器检查该对象的最新修改时间与web缓存器发来的最想修改时间不符，那么服务器就会向web缓存区发送一个包含最新对象的响应报文。
4. 若服务器检查发现该对象最近并没有修改就会向web缓存器发送一个不含请求对象的报文（为了节约带宽），报文的状态码是304，对应状态是Not Modified，即字面意思：没有修改。



## FTP 文本传输协议

FTP也是运行在TCP协议之上的，与http不同的是ftp协议使用了两个tcp连接来传输文件：

- 一个是控制连接control connection：用于之际之间传输控制信息，比如用户标识、口令、改变远程目录的命令以及存放put和获取get文件的命令。使用21号端口。
- 一个是数据连接data connection：用于实际发送一个文件，使用20号端口。

### 工作流程

1. ftp客户端首先在服务器的21号端口与服务器建立一个用于控制的tcp连接。
2. 当ftp服务器端从控制连接上收到一个文件传输的命令后（不管是往客户端传文件还是从客户端收文件），就向客户端发起一个用于数据传输的tcp连接请求。
3. ftp在该数据连接上准确第传送一个文件，传输结束后就会关闭该连接。
4. 在同一个回话期内（就是控制连接没断开且无数据连接），用户还需传输一个文件，ftp则打开另一个数据连接。

### FTP命令和回答

ftp命令和回答都是7比特的ascii格式的。

#### 每个命令后跟回车换行符，每个命令由四个大写字母ascii字符组成：

- USER username：用于向服务器传送用户标识
- PASS password：用于向服务器传送用户口令
- LIST：用于请求服务器会送当前远程目录中所有文件列表。该文件列表是经一个新建且非持续的数据连接传送而不是在tcp控制连接上传送。
- RETR filename：从远程主机当前目录检索文件。该命令引起远程主机发起一个数据连接，并经该数据连接发送所请求的文件
- STOR filename：用于在远程主机的当前目录上存放文件。

#### 与命令对应的是从服务器发来的回答。回答是以恶3位数后跟着一个可选信息：

- 331 Username OK，Password required（用户名ok，需要密码）
- 125 Data connection already open；transfer starting（数据连接已经打开，开始传送）
- 425 Can‘t open data connection（无法打开数据连接）
- 452 Error writing file （写文件差错）



## 电子邮件协议

简单邮件传输协议（Simple Mail Transfer Protocl，SMTP）

### 一封电子邮件从发送到接收（假设用户A向用户B发邮件）

1. 用户A在本地使用他自己的邮件代理程序编写电子邮件，并提供用户B的邮件地址，最后发送
2. 用户A的代理程序把报文发到他的邮件服务器，在哪里该报文被放在报文队列中
3. 用户A的邮件服务器上的smtp客户端发现这个报文，就创建一个到运行在用户B的邮件服务器上的smtp服务器的tcp连接
4. 两个服务器上的stmp建立连接后，开始传输邮件报文
5. 用户B的邮件服务器上，smtp的服务器接收该报文。
6. 用户B的邮件服务器然后将该报文放入用户B的邮箱中
7. 用户B通过使用代理程序读取该邮件

也就是说两个邮件服务器之间使用的是smtp协议。

发送方代理软件向发送方邮件服务器进行发信可以使用smtp协议，因为该协议是一个推协议（见下文），当然使用http协议也可以。但是接收方代理软件向接收方邮件服务器取信时不能使用smtp协议（也是因为它是一个推协议，而这里需要一个拉协议），接收方代理软件和邮件服务器之间可以通过第三版的邮局协议（Post Office Protocol—Version 3，POP3）、因特网邮件访问协议（internet mail access protocol， imap）以及http协议来通信。

目前最流行的代理就是基于web的电子邮件，即浏览器就是一个代理软件。浏览器即可以发信也可以收信。浏览器和邮件服务器之间不管收发都是使用http协议，但是两个邮件服务器之间仍然使用smtp协议。

### 与HTTP的对比

1. http是一个拉协议，用户使用浏览器从web服务器拉取信息；smtp是一个推协议，发送邮件服务器把文件推向接收邮件服务器
2. smtp协议每个报文使用7比特ascii码格式而http则不受这种限制
3. http将每个对象封装到它自己的http响应报文中；而smtp把所有报文对象放在一个报文之中。



## DNS：域名系统

DNS能进行主机名到IP地址转换。

#### DNS是：

1. 一个由分层的dns服务器实现的分布式数据库
2. 一个使得主机能够查询分布式数据库的应用层协议
3. dns协议运行在udp之上，使用53号端口



### dns工作机理

1. 用户主机上某个应用程序需要将主机名转换为IP地址，于是调度用dns客户端，并指定要指明的主机名
2. dns向网络中发送一个dns查询报文。所有的请求和回答报文都是使用udp数据报经端口53发送
3. 若干毫秒延迟之后，