## 互联网的路由选择协议

路由选择协议的核心就是路由算法，也就是如何得出路由表中的路由的算法。

#### 理想的路由算法应该具有的特点：

1. 算法必须是正确和完整的
2. 算法在计算上应该简单
3. 要有自适应性
4. 应具有稳定性
5. 算法应是公平的
6. 算法应是最佳的

#### 分层次的路由选择协议

问什么要分层次：因为互联网规模比较大，不可能让路由器知道如何到达所有的网络。再就是很多单位不想让外界知道自己单位网络的内部路由选择协议。

因此互联网被划分成多个较小的自治系统autonomous system，AS。

互联网把路由选择协议分为两大类：

- 内部网关协议Interior Gateway Protocol：具体有很多种如RIP和OSPF
- 外部网关协议External Gateway Protocol：目前使用的就是BGP

### 内部网关协议RIP

Routing Information Protocol路由信息协议。

RIP是一种基于距离向量的路由选择协议。说白了就是选择到达目的IP的最短路径。这种路由更新算法又称为距离向量算法。

RIP协议要求网络中每个路由器都要维护一个从它自己到其它目的网络的距离记录。

关于距离：一个路由器到其直接连接的网络的距离为1。然后路由器到其非直接连接的网络每经过一个路由器距离就加一。

RIP允许一条路径最多只能包含15个路由器。因此RIP只适用于小型互联网。

#### RIP 协议下的路由器工作原理

1. 仅和临近的路由器交换信息
2. 交换的信息是本路有其当前所知道的全部信息，也就是自己现在的路由表
3. 按固定的时间间隔交换路由信息

在路由器刚开始工作时，其路由表是空的，它只能得出与之直接相连的几个网络的距离。



RIP协议使用运输层的用户数据报UDP进行传送。

RIP协议的一个特点是：故障消息传播慢，而好消息传播快

优点是实现简单，开销较小。

缺点是限制了网络的规模。

### 内部网关协议OSPF

Open Shortest Path First开放最短路径优先。

原理简单，实现复杂。

这里使用了最短路径算法。OSPF只是一个名字，并不代表其他协议不是“最短路径优先”。像RIP更新准则也是寻找最短路径。

OSPF使用的是分布式的链路状态协议，而不像RIP那样使用距离向量协议。

#### OSPF的要点及与RIP的区别

1. OSPF向本自治系统中的所有路由器发送信息，使用洪泛法。
2. 发送的信息是与本路由器相邻的所有路由器的**链路状态**。链路状态指本路由器与哪些路由器相邻，以及该链路的度量。这里度量是一种代价，可以表示距离、费用、时延、带宽等，具体由网络管理人员设定。
3. 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。

**洪泛法：**路由器将信息通过所有输出端口向其邻近路由器发送，每一个邻近路由器再将信息发往其邻近路由器（但不发给发来信息的那个路由器）

经过路由器之间的链路状态信息的交换，所有路由器最终都能建立一个链路状态数据库，这个数据库就是全网的拓扑结构图。每个路由器使用这个数据库来构建自己的路由表。

与RIP不同的是，RIP不知道全网的拓扑结构，只有到了下一跳才知道再下一跳该如何走。

OSPF不用UDP而是直接用IP数据报发送。

#### OSPF分组有五种类型：

1. 问候分组，用来发现维持邻站的可达性
2. 数据库描述分组，向邻站发出自己的链路状态数据库中的所有链路状态项目的摘要信息
3. 链路状态请求分组，请求对方发送链路状态信息
4. 链路状态更新分组，用洪泛法对全网更新链路状态
5. 链路状态确认，对链路更新分组的确认

#### 工作机理

每组相邻的路由器每隔10秒交换一次问候分组，以确保可达，若40秒后没收到某个邻近路由器的问候，则表明该邻近路由器不可达。应立即修改数据看，并重新计算路由表。

在路由器刚开始工作时不是将自己的本地链路状态对全网广播，因为这样会占用太大网路带宽，而是发送本地已有链路状态的信息摘要。经过和其他路由器交换链路状态描述分组和后，各个路由器使用链路状态请求分组向目的路由器请求自己缺失的链路状态的详细信息。

就是各自发送自己已有信息的摘要，然后每个路由器根据摘要查看自己是否缺失某信息，若缺失就向发送该信息摘要的路由器请求详细信息。

在网络运行过程中，也就是链路状态数据库已经建立好了，这时某个路由器的链路状态发送变化，那么该路由器就向全网使用链路更新分组，用洪泛法向全网更新状态。

在收到更新分组后要回复链路状态确认分组，即使用可靠的洪泛法。

以上也就将五种分组都用上了。

